spec: v0.6

name: python

rootfs: ./Dockerfile

cmd: ["/usr/bin/python", "/src/server.py"]

template:
  source: https://github.com/unikraft/app-elfloader.git
  version: staging

unikraft:
  source: https://github.com/unikraft/unikraft.git
  version: staging
  kconfig:
    # Configurations options for app-elfloader
    # (they can't be part of the template atm)
    CONFIG_APPELFLOADER_ARCH_PRCTL: 'y'
    CONFIG_APPELFLOADER_BRK: 'y'
    CONFIG_APPELFLOADER_CUSTOMAPPNAME: 'y'
    CONFIG_APPELFLOADER_STACK_NBPAGES: 128
    CONFIG_APPELFLOADER_VFSEXEC_EXECBIT: 'n'
    CONFIG_APPELFLOADER_VFSEXEC: 'y'
    CONFIG_APPELFLOADER_HFS: 'y'
    CONFIG_APPELFLOADER_HFS_ETCRESOLVCONF: 'y'
    CONFIG_APPELFLOADER_HFS_ETCHOSTS: 'y'
    CONFIG_APPELFLOADER_HFS_ETCHOSTNAME: 'y'
    CONFIG_APPELFLOADER_HFS_REPLACEEXIST: 'y'
    # Unikraft options
    CONFIG_HAVE_PAGING_DIRECTMAP: 'y'
    CONFIG_HAVE_PAGING: 'y'
    CONFIG_I8042: 'y'
    CONFIG_LIBDEVFS_AUTOMOUNT: 'y'
    CONFIG_LIBDEVFS_DEV_NULL: 'y'
    CONFIG_LIBDEVFS_DEV_STDOUT: 'y'
    CONFIG_LIBDEVFS_DEV_ZERO: 'y'
    CONFIG_LIBDEVFS: 'y'
    CONFIG_LIBPOSIX_ENVIRON_ENVP0: "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    CONFIG_LIBPOSIX_ENVIRON_ENVP1: "LD_LIBRARY_PATH=/usr/local/lib:/usr/lib:/lib"
    CONFIG_LIBPOSIX_ENVIRON_ENVP2: "HOME=/"
    CONFIG_LIBPOSIX_ENVIRON: 'y'
    CONFIG_LIBPOSIX_ENVIRON_LIBPARAM: 'y'
    CONFIG_LIBPOSIX_ENVIRON_LIBPARAM_MAXCOUNT: '64'
    CONFIG_LIBPOSIX_EVENTFD: 'y'
    CONFIG_LIBPOSIX_FDIO: 'y'
    CONFIG_LIBPOSIX_FDTAB: 'y'
    CONFIG_LIBPOSIX_FUTEX: 'y'
    CONFIG_LIBPOSIX_MMAP: 'y'
    CONFIG_LIBPOSIX_NETLINK: 'y'
    CONFIG_LIBPOSIX_PIPE: 'y'
    CONFIG_LIBPOSIX_POLL: 'y'
    CONFIG_LIBPOSIX_PROCESS_CLONE: 'y'
    CONFIG_LIBPOSIX_SOCKET: 'y'
    CONFIG_LIBPOSIX_SYSINFO: 'y'
    CONFIG_LIBPOSIX_TIME: 'y'
    CONFIG_LIBPOSIX_TIMERFD: 'y'
    CONFIG_LIBPOSIX_UNIXSOCKET: 'y'
    CONFIG_LIBPOSIX_USER_GID: 0
    CONFIG_LIBPOSIX_USER_GROUPNAME: "root"
    CONFIG_LIBPOSIX_USER_UID: 0
    CONFIG_LIBPOSIX_USER_USERNAME: "root"
    CONFIG_LIBPOSIX_USER: 'y'
    CONFIG_LIBRAMFS: 'y'
    CONFIG_LIBSYSCALL_SHIM_HANDLER_ULTLS: 'y'
    CONFIG_LIBSYSCALL_SHIM_HANDLER: 'y'
    CONFIG_LIBSYSCALL_SHIM_LEGACY_VERBOSE: 'y'
    CONFIG_LIBSYSCALL_SHIM: 'y'
    CONFIG_LIBUKALLOCPOOL: 'y'
    CONFIG_LIBUKBLKDEV_MAXNBQUEUES: '1'
    CONFIG_LIBUKBLKDEV_DISPATCHERTHREADS: 'y'
    CONFIG_LIBUKBLKDEV_SYNC_IO_BLOCKED_WAITING: 'y'
    CONFIG_LIBUKBLKDEV: 'y'
    CONFIG_LIBUKBOOT_BANNER_MINIMAL: 'y'
    CONFIG_LIBUKBOOT_HEAP_BASE: '0x400000000'
    CONFIG_LIBUKBOOT_MAINTHREAD: 'y'
    CONFIG_LIBUKBOOT_SHUTDOWNREQ_HANDLER: 'y'
    CONFIG_LIBUKCPIO: 'y'
    CONFIG_LIBUKDEBUG_CRASH_SCREEN: 'y'
    CONFIG_LIBUKDEBUG_ENABLE_ASSERT: 'y'
    CONFIG_LIBUKDEBUG_PRINT_SRCNAME: 'n'
    CONFIG_LIBUKDEBUG_PRINT_TIME: 'y'
    CONFIG_LIBUKDEBUG_PRINTK_ERR: 'y'
    CONFIG_LIBUKDEBUG_PRINTK: 'y'
    CONFIG_LIBUKDEBUG: 'y'
    CONFIG_LIBUKFALLOC: 'y'
    CONFIG_LIBUKMPI: 'n'
    CONFIG_LIBUKSIGNAL: 'y'
    CONFIG_LIBUKRANDOM_DEVFS: 'y'
    CONFIG_LIBUKRANDOM: 'y'
    CONFIG_LIBUKRANDOM_GETRANDOM: 'y'
    CONFIG_LIBUKRANDOM_CMDLINE_SEED: 'y'
    CONFIG_LIBUKRANDOM_LCPU: 'y'
    CONFIG_LIBUKVMEM_DEFAULT_BASE: '0x0000001000000000'
    CONFIG_LIBUKVMEM_DEMAND_PAGE_IN_SIZE: 12
    CONFIG_LIBUKVMEM_PAGEFAULT_HANDLER_PRIO: 4
    CONFIG_LIBUKVMEM: 'y'
    CONFIG_LIBVFSCORE_AUTOMOUNT_CI: 'y'
    CONFIG_LIBVFSCORE_AUTOMOUNT_CI_EINITRD: 'y'
    CONFIG_LIBVFSCORE_AUTOMOUNT_UP: 'y'
    CONFIG_LIBVFSCORE_AUTOMOUNT: 'y'
    CONFIG_LIBVFSCORE_NONLARGEFILE: 'y'
    CONFIG_LIBVFSCORE: 'y'
    CONFIG_LIBUK9P: 'y'
    CONFIG_OPTIMIZE_DEADELIM: 'y'
    CONFIG_OPTIMIZE_LTO: 'y'
    CONFIG_PAGING: 'y'
    CONFIG_STACK_SIZE_PAGE_ORDER: 4 # 128 * 4K = 512K
    CONFIG_UKPLAT_MEMREGION_MAX_COUNT: 64
    CONFIG_LIBUKNETDEV_EINFO_LIBPARAM: 'y'

    # Debug options
    # CONFIG_LIBUKDEBUG_PRINTD: 'y'
    # CONFIG_LIBUKDEBUG_PRINTK_INFO: 'y'
    # CONFIG_LIBSYSCALL_SHIM_STRACE: 'y'
    # CONFIG_LIBSYSCALL_SHIM_DEBUG: 'y'

libraries:
  lwip:
    source: https://github.com/unikraft/lib-lwip.git
    version: staging
    kconfig:
      CONFIG_LWIP_LOOPIF: 'y'
      CONFIG_LWIP_UKNETDEV: 'y'
      CONFIG_LWIP_LOOPBACK: 'y'
      CONFIG_LWIP_TCP: 'y'
      CONFIG_LWIP_UDP: 'y'
      CONFIG_LWIP_RAW: 'y'
      CONFIG_LWIP_WND_SCALE: 'y'
      CONFIG_LWIP_TCP_KEEPALIVE: 'y'
      CONFIG_LWIP_THREADS: 'y'
      CONFIG_LWIP_HEAP: 'y'
      CONFIG_LWIP_SOCKET: 'y'
      CONFIG_LWIP_AUTOIFACE: 'y'
      CONFIG_LWIP_IPV4: 'y'
      CONFIG_LWIP_DHCP: 'y'
      CONFIG_LWIP_DNS: 'y'
      CONFIG_LWIP_NUM_TCPCON: 64
      CONFIG_LWIP_NUM_TCPLISTENERS: 64
      CONFIG_LWIP_ICMP: 'y'
  libelf:
    source: https://github.com/unikraft/lib-libelf.git
    version: staging

targets:
- fc/x86_64
- qemu/x86_64
